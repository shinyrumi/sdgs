import React, { useState, useEffect, useRef } from 'react';
import { Sparkles, Heart, Gift, CircleDashed, Award } from 'lucide-react';
import * as Tone from 'tone'; // Tone.js ì„í¬íŠ¸

// Tone.js ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ëŠ” ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
// ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì´ ìˆì–´ì•¼ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ê°€ ì‹œì‘ë©ë‹ˆë‹¤.
const startAudioContext = async () => {
  if (Tone.context.state !== 'running') {
    await Tone.start();
  }
};

// ìƒí’ˆ ì…ë ¥ ì»´í¬ë„ŒíŠ¸
const ProductInput = ({ product, index, onUpdate, onDelete, playClickSound }) => (
  <div className="flex items-center space-x-2 p-2 bg-pink-50 rounded-lg shadow-sm w-full">
    <input
      type="text"
      placeholder="ìƒí’ˆëª…"
      value={product.name}
      onChange={(e) => onUpdate(index, 'name', e.target.value)}
      className="p-2 border border-pink-200 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-300 flex-grow"
    />
    <input
      type="number"
      placeholder="ê°œìˆ˜"
      value={product.quantity}
      onChange={(e) => onUpdate(index, 'quantity', Math.max(1, parseInt(e.target.value) || 1))}
      min="1"
      className="p-2 border border-pink-200 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-300 w-20 text-center"
    />
    <button
      onClick={() => {
        onDelete(index);
        playClickSound();
      }}
      className="p-2 bg-red-300 text-white rounded-md hover:bg-red-400 transition-colors duration-200 shadow-md"
      aria-label="ìƒí’ˆ ì‚­ì œ"
    >
      <Heart size={20} fill="white" />
    </button>
  </div>
);

// ìƒí’ˆ ë° ì°¸ê°€ì ì…ë ¥ í¼ ì»´í¬ë„ŒíŠ¸
const InputForm = ({ onStartDraw, playClickSound }) => {
  const [products, setProducts] = useState([{ name: '', quantity: 1 }]);
  const [totalParticipants, setTotalParticipants] = useState(1);
  const [errorMessage, setErrorMessage] = useState('');

  const addProduct = () => {
    setProducts([...products, { name: '', quantity: 1 }]);
    playClickSound();
  };

  const updateProduct = (index, field, value) => {
    const newProducts = [...products];
    newProducts[index][field] = value;
    setProducts(newProducts);
  };

  const deleteProduct = (index) => {
    const newProducts = products.filter((_, i) => i !== index);
    setProducts(newProducts.length > 0 ? newProducts : [{ name: '', quantity: 1 }]);
    playClickSound();
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    playClickSound();
    setErrorMessage('');

    const validProducts = products.filter(p => p.name.trim() !== '' && p.quantity > 0);
    if (validProducts.length === 0) {
      setErrorMessage('ì ì–´ë„ í•˜ë‚˜ì˜ ìƒí’ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
      return;
    }

    if (totalParticipants < 1) {
        setErrorMessage('ì°¸ê°€ì ìˆ˜ëŠ” 1ëª… ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤!');
        return;
    }

    onStartDraw(validProducts, totalParticipants);
  };

  return (
    <div className="bg-white p-6 rounded-3xl shadow-xl border-4 border-pink-200 max-w-lg mx-auto transform hover:scale-105 transition-transform duration-300">
      <h2 className="text-3xl font-bold text-center text-pink-500 mb-6 flex items-center justify-center gap-2">
        <Sparkles className="text-yellow-400" size={32} />
        ë£°ë › ë½‘ê¸° ì„¤ì •
        <Sparkles className="text-yellow-400" size={32} />
      </h2>
      <form onSubmit={handleSubmit} className="space-y-4">
        <div className="space-y-3">
          <label className="block text-xl font-semibold text-purple-600">ìƒí’ˆ ëª©ë¡:</label>
          {products.map((product, index) => (
            <ProductInput
              key={index}
              product={product}
              index={index}
              onUpdate={updateProduct}
              onDelete={deleteProduct}
              playClickSound={playClickSound}
            />
          ))}
          <button
            type="button"
            onClick={addProduct}
            className="w-full py-3 px-4 bg-purple-300 text-white font-bold rounded-xl hover:bg-purple-400 transition-colors duration-200 shadow-lg flex items-center justify-center gap-2"
          >
            <Gift size={20} /> ìƒí’ˆ ì¶”ê°€
          </button>
        </div>

        <div>
          <label htmlFor="participants" className="block text-xl font-semibold text-purple-600 mb-2">
            ì „ì²´ ì°¸ê°€ì ìˆ˜:
          </label>
          <input
            id="participants"
            type="number"
            value={totalParticipants}
            onChange={(e) => setTotalParticipants(Math.max(1, parseInt(e.target.value) || 1))}
            min="1"
            className="w-full p-3 border-4 border-purple-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-300 text-lg"
          />
        </div>

        {errorMessage && (
          <p className="text-red-500 text-center font-semibold text-sm">{errorMessage}</p>
        )}

        <button
          type="submit"
          className="w-full py-4 px-6 bg-pink-500 text-white text-2xl font-extrabold rounded-full hover:bg-pink-600 transition-colors duration-300 shadow-2xl transform hover:scale-105"
        >
          ì¶”ì²¨ ì‹œì‘!
        </button>
      </form>
    </div>
  );
};

// ë£°ë › ì»´í¬ë„ŒíŠ¸
const Roulette = ({ prizes, winningPrizeName, isSpinning, onSpinComplete, isDrawingAll }) => {
  const [displayPrize, setDisplayPrize] = useState('');
  const animationDuration = 3000; // 3ì´ˆ ë™ì•ˆ ë£°ë › ì• ë‹ˆë©”ì´ì…˜ ì§„í–‰

  useEffect(() => {
    let spinInterval;
    if (isSpinning && !isDrawingAll) { // ì „ì²´ ì¶”ì²¨ ëª¨ë“œì—ì„œëŠ” ë£°ë › ì• ë‹ˆë©”ì´ì…˜ ìŠ¤í‚µ
      spinInterval = setInterval(() => {
        setDisplayPrize(prizes[Math.floor(Math.random() * prizes.length)] || 'ê½'); // 'ê½'ìœ¼ë¡œ í‘œì‹œ
      }, 100);

      setTimeout(() => {
        clearInterval(spinInterval);
        setDisplayPrize(winningPrizeName);
        onSpinComplete();
      }, animationDuration);
    } else if (!isSpinning && displayPrize === '') {
      setDisplayPrize('ë£°ë › ëŒ€ê¸°ì¤‘...');
    } else if (isDrawingAll) { // ì „ì²´ ì¶”ì²¨ ëª¨ë“œì¼ ë•Œ ë£°ë › ë©”ì‹œì§€ ë³€ê²½
      setDisplayPrize('ì „ì²´ ì¶”ì²¨ ì™„ë£Œ!');
    }

    return () => clearInterval(spinInterval);
  }, [isSpinning, prizes, winningPrizeName, onSpinComplete, displayPrize, isDrawingAll]);

  return (
    <div className="flex flex-col items-center justify-center space-y-6">
      <div
        className={`relative w-64 h-64 md:w-80 md:h-80 bg-gradient-to-br from-yellow-200 to-pink-300 rounded-full flex items-center justify-center shadow-inner-xl border-8 border-purple-400 overflow-hidden ${
          isSpinning && !isDrawingAll ? 'animate-spin-fast' : '' // ì „ì²´ ì¶”ì²¨ ëª¨ë“œì¼ ë•ŒëŠ” ìŠ¤í•€ ì• ë‹ˆë©”ì´ì…˜ ì ìš© ì•ˆí•¨
        }`}
      >
        <div className="absolute inset-0 bg-white rounded-full opacity-30 animate-pulse-slow"></div>
        <div className="relative text-center text-3xl md:text-4xl font-extrabold text-purple-800 p-4 bg-white rounded-full shadow-lg border-4 border-yellow-300 z-10 w-48 h-48 md:w-60 md:h-60 flex items-center justify-center">
          {isSpinning && !isDrawingAll ? (
            <CircleDashed className="animate-spin text-purple-500" size={60} />
          ) : (
            displayPrize
          )}
        </div>
        <div className="absolute -top-6 right-1/2 translate-x-1/2 transform rotate-45 text-yellow-500 z-20">
          <Sparkles size={48} fill="currentColor" />
        </div>
      </div>
    </div>
  );
};

// ì¶”ì²¨ ê²°ê³¼ ë° ì°¸ê°€ì ë¦¬ìŠ¤íŠ¸ ì»´í¬ë„ŒíŠ¸
const ResultsDisplay = ({
  results,
  currentParticipantIndex,
  onDrawParticipant,
  onDrawAllParticipants,
  isDrawComplete,
  isSpinningRoulette,
  isDrawingAll,
  groupedResults,
  onRestart, // ìƒˆë¡œ ì¶”ê°€ëœ onRestart prop
  playClickSound
}) => {
  return (
    <div className="bg-white p-6 rounded-3xl shadow-xl border-4 border-blue-200 max-w-md mx-auto">
      <h2 className="text-3xl font-bold text-center text-blue-500 mb-6 flex items-center justify-center gap-2">
        <Heart className="text-pink-400" size={32} />
        ì¶”ì²¨ ê²°ê³¼
        <Heart className="text-pink-400" size={32} />
      </h2>
      {isDrawComplete && isDrawingAll ? ( // ì „ì²´ ì¶”ì²¨ì´ ì™„ë£Œë˜ë©´ ìƒí’ˆë³„ë¡œ ê·¸ë£¹í™”ëœ ê²°ê³¼ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
        <div className="space-y-4">
          <h3 className="text-2xl font-bold text-center text-purple-600 mb-4">âœ¨ ì „ì²´ ì¶”ì²¨ ê²°ê³¼ ìš”ì•½ âœ¨</h3>
          {Object.entries(groupedResults).map(([prizeName, participants]) => (
            <div key={prizeName} className="p-3 bg-blue-50 rounded-xl shadow-sm border-2 border-blue-100">
              <span className="font-bold text-purple-700 text-xl">{prizeName}: </span>
              <span className="text-blue-800 text-lg">{participants.map(p => `${p}ë²ˆ`).join(', ')}</span>
            </div>
          ))}
        </div>
      ) : ( // ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ê¸°ì¡´ì˜ ì°¸ê°€ìë³„ ë¦¬ìŠ¤íŠ¸ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
        <ul className="space-y-3 max-h-80 overflow-y-auto pr-2 custom-scrollbar">
          {results.map((result, index) => (
            <li
              key={result.participantNumber}
              className={`flex items-center justify-between p-3 rounded-xl shadow-md border-2 ${
                // ì „ì²´ ì¶”ì²¨ ëª¨ë“œì—ì„œëŠ” í˜„ì¬ ì¸ë±ìŠ¤ ê°•ì¡°í•˜ì§€ ì•ŠìŒ
                !isDrawingAll && index === currentParticipantIndex && !isDrawComplete ? 'bg-yellow-100 border-yellow-300 animate-pulse' : 'bg-blue-50 border-blue-100'
              }`}
            >
              <span className="font-semibold text-blue-800 text-lg">
                ì°¸ê°€ì {result.participantNumber}ë‹˜:
              </span>
              <span className="font-bold text-purple-700 text-xl">
                {/* ì „ì²´ ì¶”ì²¨ ëª¨ë“œì—ì„œëŠ” í•­ìƒ prizeWonì„ í‘œì‹œ, ê°œë³„ ì¶”ì²¨ì—ì„œëŠ” revealed ìƒíƒœì— ë”°ë¼ í‘œì‹œ */}
                {(isDrawingAll || result.revealed) ? result.prizeWon : (index === currentParticipantIndex && isSpinningRoulette ? 'ì¶”ì²¨ ì¤‘...' : 'ëŒ€ê¸° ì¤‘...')}
              </span>
            </li>
          ))}
        </ul>
      )}

      {/* ì¶”ì²¨ ì§„í–‰ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ë²„íŠ¼ì„ ë³´ì—¬ì¤ë‹ˆë‹¤. */}
      {!isDrawComplete && (
        <div className="mt-6 flex flex-col gap-4">
          <button
            onClick={() => {
              onDrawParticipant(currentParticipantIndex);
              playClickSound();
            }}
            disabled={isSpinningRoulette || isDrawingAll}
            className={`w-full py-3 px-4 text-white text-xl font-bold rounded-full shadow-lg transition-colors duration-200 transform hover:scale-105 ${
              isSpinningRoulette || isDrawingAll ? 'bg-gray-400 cursor-not-allowed' : 'bg-purple-400 hover:bg-purple-500'
            }`}
          >
            {isSpinningRoulette && !isDrawingAll ? (
              <>
                <CircleDashed className="inline-block mr-2 animate-spin" size={24} />
                ì¶”ì²¨ ì¤‘...
              </>
            ) : (
              `ì°¸ê°€ì ${results[currentParticipantIndex]?.participantNumber || ''}ë‹˜ ì¶”ì²¨í•˜ê¸°`
            )}
          </button>
          <button
            onClick={() => {
              onDrawAllParticipants();
              playClickSound();
            }}
            disabled={isSpinningRoulette || isDrawingAll}
            className={`w-full py-3 px-4 text-white text-xl font-bold rounded-full shadow-lg transition-colors duration-200 transform hover:scale-105 ${
              isSpinningRoulette || isDrawingAll ? 'bg-gray-400 cursor-not-allowed' : 'bg-pink-500 hover:bg-pink-600'
            }`}
          >
            {isDrawingAll ? (
              <>
                <CircleDashed className="inline-block mr-2 animate-spin" size={24} />
                ì „ì²´ ì¶”ì²¨ ì¤‘...
              </>
            ) : (
              'ì „ì²´ ì¶”ì²¨í•˜ê¸°'
            )}
          </button>
        </div>
      )}
      {isDrawComplete && (
        <div className="mt-6 text-center">
          <p className="text-2xl font-extrabold text-green-600 animate-bounce flex items-center justify-center gap-2 mb-4">
            <Sparkles className="text-yellow-400" size={28} />
            ëª¨ë“  ì¶”ì²¨ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
            <Sparkles className="text-yellow-400" size={28} />
          </p>
          <button
            onClick={() => {
              onRestart();
              playClickSound();
            }}
            className="w-full py-3 px-4 bg-blue-500 text-white text-xl font-bold rounded-full shadow-lg hover:bg-blue-600 transition-colors duration-200 transform hover:scale-105"
          >
            ë‹¤ì‹œ ì‹œì‘í•˜ê¸°
          </button>
        </div>
      )}
    </div>
  );
};

const App = () => {
  const [appState, setAppState] = useState('input'); // 'input' (ì…ë ¥), 'drawing' (ì¶”ì²¨ ì§„í–‰)
  const [products, setProducts] = useState([]);
  const [totalParticipants, setTotalParticipants] = useState(0);
  const [drawResults, setDrawResults] = useState([]); // { participantNumber, prizeWon, revealed } í˜•íƒœì˜ ì¶”ì²¨ ê²°ê³¼
  const [prizePool, setPrizePool] = useState([]); // ëª¨ë“  ìƒí’ˆì„ í¼ì³ë†“ì€ ë¦¬ìŠ¤íŠ¸
  const [currentParticipantIndex, setCurrentParticipantIndex] = useState(0);
  const [winningPrizeForRoulette, setWinningPrizeForRoulette] = useState('');
  const [isSpinningRoulette, setIsSpinningRoulette] = useState(false);
  const [isDrawingAll, setIsDrawingAll] = useState(false); // ì „ì²´ ì¶”ì²¨ ëª¨ë“œ ìƒíƒœ ì¶”ê°€
  const [groupedResults, setGroupedResults] = useState({}); // ìƒí’ˆë³„ ê·¸ë£¹í™”ëœ ê²°ê³¼ ìƒíƒœ ì¶”ê°€

  // Tone.js ì‚¬ìš´ë“œ ì¸ìŠ¤í„´ìŠ¤
  const clickSynth = useRef(null);
  const spinOscillator = useRef(null);
  const stopSynth = useRef(null);
  const fireworksSynth = useRef(null); // í­ì£½ ì‚¬ìš´ë“œ ì¶”ê°€

  // ì‚¬ìš´ë“œ ì´ˆê¸°í™” ë° AudioContext ì‹œì‘ (ì²« ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ì‹œ)
  useEffect(() => {
    clickSynth.current = new Tone.MembraneSynth().toDestination();
    spinOscillator.current = new Tone.Oscillator('C5', 'sawtooth').toDestination();
    spinOscillator.current.volume.value = -20; // ìŠ¤í•€ ì‚¬ìš´ë“œ ë³¼ë¥¨ ì¡°ì ˆ
    stopSynth.current = new Tone.Synth({
      oscillator: { type: "sine" },
      envelope: {
        attack: 0.01,
        decay: 0.5,
        sustain: 0.0,
        release: 0.5,
      }
    }).toDestination();
    fireworksSynth.current = new Tone.NoiseSynth({ // í­ì£½ ì‚¬ìš´ë“œìš© ë…¸ì´ì¦ˆ ì‹ ë””ì‚¬ì´ì €
      noise: { type: "white" },
      envelope: {
        attack: 0.001,
        decay: 0.6,
        sustain: 0.0,
        release: 0.2
      }
    }).toDestination();

    // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© (í´ë¦­ ë˜ëŠ” í„°ì¹˜) ì‹œ AudioContext ì‹œì‘
    const handleUserInteraction = () => {
      startAudioContext();
      document.body.removeEventListener('click', handleUserInteraction);
      document.body.removeEventListener('touchstart', handleUserInteraction);
    };
    document.body.addEventListener('click', handleUserInteraction, { once: true });
    document.body.addEventListener('touchstart', handleUserInteraction, { once: true });


    return () => {
      clickSynth.current?.dispose();
      spinOscillator.current?.dispose();
      stopSynth.current?.dispose();
      fireworksSynth.current?.dispose(); // í­ì£½ ì‚¬ìš´ë“œ ì •ë¦¬
      document.body.removeEventListener('click', handleUserInteraction);
      document.body.removeEventListener('touchstart', handleUserInteraction);
    };
  }, []);

  // ì‚¬ìš´ë“œ ì¬ìƒ í•¨ìˆ˜ë“¤
  const playClickSound = () => {
    if (Tone.context.state === 'running') {
      clickSynth.current.triggerAttackRelease('C4', '8n');
    }
  };

  const startSpinSound = () => {
    if (Tone.context.state === 'running') {
      spinOscillator.current.start();
    }
  };

  const stopSpinSound = () => {
    if (Tone.context.state === 'running') {
      spinOscillator.current.stop();
    }
  };

  const playStopSound = () => {
    if (Tone.context.state === 'running') {
      stopSynth.current.triggerAttackRelease('G4', '4n');
    }
  };

  const playFireworksSound = () => {
    if (Tone.context.state === 'running') {
      fireworksSynth.current.triggerAttackRelease('8n', '+0.1');
      setTimeout(() => fireworksSynth.current.triggerAttackRelease('8n', '+0.2'), 100);
      setTimeout(() => fireworksSynth.current.triggerAttackRelease('8n', '+0.3'), 200);
    }
  };


  // ì¶”ì²¨ ì‹œì‘ í•¸ë“¤ëŸ¬
  const handleStartDraw = (inputProducts, inputTotalParticipants) => {
    setProducts(inputProducts);
    setTotalParticipants(inputTotalParticipants);

    const newPrizePool = inputProducts.flatMap(p =>
      Array(p.quantity).fill(p.name)
    );

    const shuffledPrizePool = [...newPrizePool];
    for (let i = shuffledPrizePool.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffledPrizePool[i], shuffledPrizePool[j]] = [shuffledPrizePool[j], shuffledPrizePool[i]];
    }
    setPrizePool(shuffledPrizePool);

    const initialResults = Array.from({ length: inputTotalParticipants }, (_, i) => ({
      participantNumber: i + 1,
      // ìƒí’ˆ í’€ì˜ ì¸ë±ìŠ¤ê°€ ìœ íš¨í•˜ë©´ ìƒí’ˆì„ í• ë‹¹, ì•„ë‹ˆë©´ 'ê½'ìœ¼ë¡œ í• ë‹¹
      prizeWon: shuffledPrizePool[i] !== undefined ? shuffledPrizePool[i] : 'ê½',
      revealed: false,
    }));
    setDrawResults(initialResults);

    setAppState('drawing');
    setCurrentParticipantIndex(0);
    setIsSpinningRoulette(false);
    setIsDrawingAll(false); // ìƒˆë¡œìš´ ì¶”ì²¨ ì‹œì‘ ì‹œ ì „ì²´ ì¶”ì²¨ ëª¨ë“œ ë¹„í™œì„±í™”
    setGroupedResults({}); // ìƒˆë¡œìš´ ì¶”ì²¨ ì‹œì‘ ì‹œ ê·¸ë£¹í™”ëœ ê²°ê³¼ ì´ˆê¸°í™”
    setWinningPrizeForRoulette(initialResults[0]?.prizeWon || 'ê½'); // ì²« ì°¸ê°€ìì˜ ìƒí’ˆì´ 'ê½'ì¼ ìˆ˜ ìˆìŒ
  };

  // íŠ¹ì • ì°¸ê°€ì ì¶”ì²¨ ì‹œì‘ í•¸ë“¤ëŸ¬
  const handleDrawParticipant = (index) => {
    if (isSpinningRoulette || index !== currentParticipantIndex || isDrawingAll) return; // ì „ì²´ ì¶”ì²¨ ì¤‘ì¼ ë•Œ ê°œë³„ ì¶”ì²¨ ë°©ì§€

    setIsSpinningRoulette(true);
    startSpinSound(); // ìŠ¤í•€ ì‚¬ìš´ë“œ ì‹œì‘
    setWinningPrizeForRoulette(drawResults[index]?.prizeWon || 'ê½');
  };

  // ì „ì²´ ì¶”ì²¨ ì‹œì‘ í•¸ë“¤ëŸ¬
  const handleDrawAllParticipants = () => {
    if (isSpinningRoulette || isDrawingAll || totalParticipants === 0) return; // ì´ë¯¸ ì¶”ì²¨ ì¤‘ì´ê±°ë‚˜ ì°¸ê°€ìê°€ ì—†ìœ¼ë©´ ë°©ì§€

    setIsDrawingAll(true);
    playFireworksSound(); // ì „ì²´ ì¶”ì²¨ ì‹œì‘ ì‹œ í­ì£½ ì‚¬ìš´ë“œ ì¬ìƒ

    // ì´ë¯¸ ì¶”ì²¨ëœ ì°¸ê°€ìì˜ ê²°ê³¼ëŠ” ìœ ì§€í•˜ê³ , ì•„ì§ ì¶”ì²¨ë˜ì§€ ì•Šì€ ì°¸ê°€ìë“¤ë§Œ ì—…ë°ì´íŠ¸
    const updatedResults = drawResults.map((result, index) => {
      if (!result.revealed) { // ì•„ì§ ê³µê°œë˜ì§€ ì•Šì€ ê²°ê³¼ë§Œ ì—…ë°ì´íŠ¸
        return {
          ...result,
          revealed: true,
          // ìƒí’ˆì€ ì´ë¯¸ handleStartDrawì—ì„œ í• ë‹¹ë˜ì—ˆìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        };
      }
      return result;
    });
    setDrawResults(updatedResults);

    // ê²°ê³¼ë¥¼ ìƒí’ˆë³„ë¡œ ê·¸ë£¹í™” (ì—…ë°ì´íŠ¸ëœ ê²°ê³¼ ì‚¬ìš©)
    const newGroupedResults = updatedResults.reduce((acc, current) => {
      const prize = current.prizeWon;
      if (!acc[prize]) {
        acc[prize] = [];
      }
      acc[prize].push(current.participantNumber);
      return acc;
    }, {});
    setGroupedResults(newGroupedResults); // ê·¸ë£¹í™”ëœ ê²°ê³¼ ìƒíƒœ ì—…ë°ì´íŠ¸

    // ëª¨ë“  ì¶”ì²¨ì´ ì™„ë£Œë˜ì—ˆìŒì„ í‘œì‹œ
    setCurrentParticipantIndex(totalParticipants);
    setIsSpinningRoulette(false); // ë£°ë ›ì€ ìŠ¤í•€í•˜ì§€ ì•ŠìŒ
    // isDrawingAll ìƒíƒœëŠ” ResultsDisplayì—ì„œ ì™„ë£Œ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤€ í›„ ì¢…ë£Œ
  };

  // ë£°ë › ìŠ¤í•€ ì™„ë£Œ í•¸ë“¤ëŸ¬ (ê°œë³„ ì¶”ì²¨ ì‹œì—ë§Œ ì‚¬ìš©)
  const handleSpinComplete = () => {
    setIsSpinningRoulette(false);
    stopSpinSound(); // ìŠ¤í•€ ì‚¬ìš´ë“œ ì¤‘ì§€
    playStopSound(); // ë©ˆì¶¤ ì‚¬ìš´ë“œ ì¬ìƒ

    setDrawResults(prevResults =>
      prevResults.map((res, idx) =>
        idx === currentParticipantIndex ? { ...res, revealed: true } : res
      )
    );

    // ë‹¤ìŒ ì°¸ê°€ìë¡œ ìë™ ì´ë™
    setTimeout(() => {
      const nextIndex = currentParticipantIndex + 1;
      if (nextIndex < totalParticipants) {
        // ê°œë³„ ì¶”ì²¨ì´ë¯€ë¡œ ë‹¤ìŒ ìŠ¤í•€ì„ ìë™ìœ¼ë¡œ ì‹œì‘í•˜ì§€ ì•ŠìŒ
        setCurrentParticipantIndex(nextIndex);
        setWinningPrizeForRoulette(drawResults[nextIndex]?.prizeWon || 'ê½');
      } else {
        // ëª¨ë“  ì¶”ì²¨ ì™„ë£Œ (ê°œë³„ ì¶”ì²¨ ëª¨ë“œ ì¢…ë£Œ)
        setCurrentParticipantIndex(totalParticipants);
        setIsDrawingAll(false); // ì•ˆì „ì„ ìœ„í•´ ì „ì²´ ì¶”ì²¨ ëª¨ë“œ ì¢…ë£Œ
      }
    }, 1000); // 1ì´ˆ ëŒ€ê¸° í›„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰
  };

  // ì•±ì„ ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦¬ëŠ” í•¨ìˆ˜
  const handleRestart = () => {
    setAppState('input');
    setProducts([]);
    setTotalParticipants(1);
    setDrawResults([]);
    setPrizePool([]);
    setCurrentParticipantIndex(0);
    setWinningPrizeForRoulette('');
    setIsSpinningRoulette(false);
    setIsDrawingAll(false);
    setGroupedResults({});
  };

  const isDrawComplete = currentParticipantIndex >= totalParticipants;

  // ë°°ê²½ ì´ëª¨ì§€ ìœ„ì¹˜ë¥¼ ìœ„í•œ ë°°ì—´
  const emojis = [
    { emoji: 'ğŸ¥', top: '10%', left: '5%', size: '3em' },
    { emoji: 'ğŸ†', top: '20%', right: '8%', size: '3.5em' },
    { emoji: 'ğŸ¥', bottom: '15%', left: '15%', size: '2.8em' },
    { emoji: 'ğŸ†', top: '5%', left: '30%', size: '3.2em' },
    { emoji: 'ğŸ¥', bottom: '5%', right: '20%', size: '3em' },
    { emoji: 'ğŸ†', top: '40%', right: '2%', size: '3.8em' },
    { emoji: 'ğŸ¥', top: '50%', left: '10%', size: '3.5em' },
    { emoji: 'ğŸ†', bottom: '25%', left: '50%', size: '3em' },
  ];

  return (
    <div className="min-h-screen bg-gradient-to-br from-pink-100 to-purple-200 flex flex-col items-center justify-center p-4 text-gray-800 font-cute relative overflow-hidden"> {/* ëª¨ë“  ê¸€ì”¨ì²´ í†µì¼ ë° ì´ëª¨ì§€ ë°°ì¹˜ë¥¼ ìœ„í•œ relative, overflow-hidden */}
      <style>
        {`
        /* êµ¬ê¸€ í°íŠ¸ ì„í¬íŠ¸: Cute Font */
        @import url('https://fonts.googleapis.com/css2?family=Cute+Font&display=swap');
        .font-cute {
          font-family: 'Cute Font', cursive;
        }

        /* ë£°ë › ë¹ ë¥¸ íšŒì „ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes spin-fast {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        /* ë£°ë › ë‚´ë¶€ ìš”ì†Œ ëŠë¦° ë§¥ë°• ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse-slow {
          0%, 100% { transform: scale(1); opacity: 0.3; }
          50% { transform: scale(1.05); opacity: 0.5; }
        }
        /* í˜ì´ë“œ ì¸ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* ë°”ìš´ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .animate-spin-fast {
          animation: spin-fast 0.5s linear infinite;
        }
        .animate-pulse-slow {
          animation: pulse-slow 2s infinite ease-in-out;
        }
        .animate-fade-in {
            animation: fade-in 1s ease-out forwards;
        }
        .animate-bounce {
            animation: bounce 0.8s infinite alternate;
        }

        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        .custom-scrollbar::-webkit-scrollbar {
          width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: #e0aaff; /* ì—°ë³´ë¼ìƒ‰ */
          border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background: #c77dff; /* ì§„í•œ ì—°ë³´ë¼ìƒ‰ */
        }

        /* ë°°ê²½ ì´ëª¨ì§€ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes float-emoji {
            0% { transform: translateY(0px) rotate(0deg); opacity: 0.8; }
            50% { transform: translateY(-10px) rotate(5deg); opacity: 1; }
            100% { transform: translateY(0px) rotate(0deg); opacity: 0.8; }
        }
        .emoji-background {
            position: absolute;
            animation: float-emoji 5s ease-in-out infinite alternate;
            pointer-events: none; /* ì´ëª¨ì§€ê°€ í´ë¦­ì„ ë°©í•´í•˜ì§€ ì•Šë„ë¡ */
            z-index: 0; /* ë°°ê²½ ìš”ì†Œë¡œ */
        }
        `}
      </style>

      {/* ë°°ê²½ ì´ëª¨ì§€ë“¤ */}
      {emojis.map((e, i) => (
        <span
          key={i}
          className="emoji-background"
          style={{ top: e.top, left: e.left, right: e.right, fontSize: e.size, animationDelay: `${i * 0.5}s` }}
        >
          {e.emoji}
        </span>
      ))}

      {/* ì•± ì œëª© */}
      <h1 className="text-5xl font-extrabold text-white text-center mb-8 drop-shadow-lg animate-fade-in font-cute z-10">
        âœ¨ í–‰ìš´ì˜ ë£°ë › ë½‘ê¸°! âœ¨
      </h1>

      {appState === 'input' ? (
        // ì´ˆê¸° ì…ë ¥ í¼
        <InputForm onStartDraw={handleStartDraw} playClickSound={playClickSound} />
      ) : (
        // ì¶”ì²¨ ì§„í–‰ í™”ë©´
        <div className="flex flex-col md:flex-row items-start md:items-center justify-center gap-8 md:gap-12 w-full max-w-6xl z-10">
          <div className="flex-1 min-w-[300px] flex items-center justify-center order-2 md:order-1">
            <Roulette
              prizes={prizePool}
              winningPrizeName={winningPrizeForRoulette}
              isSpinning={isSpinningRoulette}
              onSpinComplete={handleSpinComplete}
              isDrawingAll={isDrawingAll}
            />
          </div>
          <div className="flex-1 min-w-[300px] order-1 md:order-2">
            <ResultsDisplay
              results={drawResults}
              currentParticipantIndex={currentParticipantIndex}
              onDrawParticipant={handleDrawParticipant}
              onDrawAllParticipants={handleDrawAllParticipants}
              isDrawComplete={isDrawComplete}
              isSpinningRoulette={isSpinningRoulette}
              isDrawingAll={isDrawingAll}
              groupedResults={groupedResults}
              onRestart={handleRestart} // onRestart prop ì „ë‹¬
              playClickSound={playClickSound}
            />
          </div>
        </div>
      )}
    </div>
  );
};

export default App;
